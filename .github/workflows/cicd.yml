# 1 워크플로의 이름 지정
name: CI/CD

# 2 워크플로가 시작될 조건 지정
on:
  push:
    branches: [ dev ]

jobs:
  build:
    runs-on: ubuntu-latest # 3 실행 환경 지정
    #4 실행스텝지정
    steps:
      - name: Check out the code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build

          #2 현재시간가져오기
      - name: Get current time
        uses: josStorer/get-current-time@v2.0.2
        id: current-time
        with:
          format: YYYY-MM-DDTHH-mm-ss
          utcOffset: "+09:00"
      # SSH 설정
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{secrets.MYROK_EC2_SSH_KEY}}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # 프라이빗 키의 첫 줄 확인
          head -n 1 ~/.ssh/id_rsa

      - name: Add EC2 Public IP
        run: |
          ssh-keyscan -H 43.201.149.117 >> ~/.ssh/known_hosts
      # JAR 파일을 EC2로 복사
      - name: Copy JAR file to EC2
        run: |
          scp -i ~/.ssh/id_rsa build/libs/myrok-0.0.1-SNAPSHOT.jar ubuntu@43.201.149.117:/home/ubuntu/app_build/
      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@43.201.149.117 'bash -s' < deploy_script.sh

